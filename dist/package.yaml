#! Copyright 2021-2022 VMware Inc.
#!
#! Licensed under the Apache License, Version 2.0 (the "License");
#! you may not use this file except in compliance with the License.
#! You may obtain a copy of the License at
#!
#!     http://www.apache.org/licenses/LICENSE-2.0
#!
#! Unless required by applicable law or agreed to in writing, software
#! distributed under the License is distributed on an "AS IS" BASIS,
#! WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#! See the License for the specific language governing permissions and
#! limitations under the License.

#@ load("@ytt:data", "data")

---
apiVersion: data.packaging.carvel.dev/v1alpha1
kind: Package
metadata:
  name: #@ data.values.name + '.' + data.values.version
spec:
  refName: #@ data.values.name
  version: #@ data.values.version
  valuesSchema:
    openAPIv3:
      title: #@ data.values.name + '.' + data.values.version + ' values schema'
      properties: 
        ca_cert_data:
          type: string
          description: "Optional: PEM Encoded certificate data for image registries with private CA."
          default: ""
        stand_alone:
          type: boolean
          description: "Optional: run independent of Cartographer, creates the cartographer-system namespace"
          default: false
        aws_iam_role_arn:
          type: string
          description: "Optional: Arn role that has access to pull images from ECR container registry"
          default: ""
        limits_cpu:
          anyOf:
          - type: integer
          - type: string
          pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
          x-kubernetes-int-or-string: true
          description: "Optional: Cpu usage limits for the controller to use with the default value set to 100m"
          default: 1000m
        limits_memory:
          description: "Optional: Memory usage limits for the controller with default set to 256Mi"
          anyOf:
          - type: integer
          - type: string
          pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
          x-kubernetes-int-or-string: true
          default: 128Mi
        requests_cpu:
          description: "Optional: Requests minimum cpu reserved"
          anyOf: 
          - type: integer
          - type: string
          pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
          x-kubernetes-int-or-string: true
          default: 250m
        requests_memory:
          description: "Optional: Requests minimum memory reserved"
          anyOf:
           - type: integer
           - type: string
          pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
          x-kubernetes-int-or-string: true
          default: 128Mi

  template:
    spec:
      fetch:
      - imgpkgBundle:
          image: #@ data.values.image
      template:
      - kbld:
          paths:
          - .imgpkg/images.yml
          - config/cartographer-conventions.yaml
      - ytt:
          paths:
          - "-"
          - bundle.yaml
          - bundle.values.yaml
          - ca-overlay.yaml
      deploy:
      - kapp: {}